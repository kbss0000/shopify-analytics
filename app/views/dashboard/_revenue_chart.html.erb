<!-- Revenue Chart -->
<div class="lg:col-span-2 card p-6">
  <div class="flex flex-wrap items-start justify-between gap-4 mb-6">
    <div>
      <h2 class="section-title"><%= t('dashboard.revenue_trends', default: 'Revenue Trends') %></h2>
      <p class="section-subtitle mt-1"><%= t('dashboard.performance_over_time', default: 'Performance over time') %></p>
    </div>
  </div>
  
  <div class="relative" style="min-height: 350px;">
    <% if @stats[:revenue_by_date].present? && @stats[:revenue_by_date].any? %>
      <div id="revenue-chart" style="height: 350px; width: 100%; position: relative; display: block; visibility: visible; opacity: 1;"></div>
      <script>
        (function() {
          function renderChart() {
            if (typeof Chartkick !== 'undefined' && typeof Chart !== 'undefined') {
              var data = <%= @stats[:revenue_by_date].to_json.html_safe %>;
              console.log('Rendering chart with data:', Object.keys(data).length, 'points');
              var chart = new Chartkick.LineChart('revenue-chart', data, {
                height: "350px",
                colors: ["#22c55e"],
                library: { 
                  backgroundColor: 'transparent',
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: { 
                    legend: { display: false },
                    tooltip: {
                      backgroundColor: 'rgba(0, 0, 0, 0.8)',
                      titleColor: '#fff',
                      bodyColor: '#fff',
                      borderColor: 'rgba(34, 197, 94, 0.5)',
                      borderWidth: 1,
                      cornerRadius: 8,
                      padding: 12
                    }
                  },
                  scales: {
                    x: { 
                      grid: { display: false, drawBorder: false }, 
                      ticks: { 
                        color: 'rgba(255, 255, 255, 0.4)', 
                        font: { family: 'Inter', size: 11, weight: 500 } 
                      },
                      border: { display: false }
                    },
                    y: { 
                      grid: { 
                        color: 'rgba(255, 255, 255, 0.05)', 
                        drawBorder: false 
                      }, 
                      ticks: { 
                        color: 'rgba(255, 255, 255, 0.4)', 
                        font: { family: 'Inter', size: 11, weight: 500 }
                      },
                      border: { display: false }
                    }
                  },
                  elements: {
                    line: { 
                      tension: 0.4, 
                      borderWidth: 3, 
                      borderColor: '#22c55e', 
                      fill: true, 
                      backgroundColor: 'rgba(34, 197, 94, 0.1)' 
                    },
                    point: { 
                      radius: 0, 
                      hoverRadius: 8, 
                      hoverBackgroundColor: '#22c55e', 
                      hoverBorderColor: 'rgba(0, 0, 0, 0.8)', 
                      hoverBorderWidth: 3 
                    }
                  }
                }
              });
              console.log('✅ Chart rendered manually', chart);
              
              // Verify chart was created and make it visible
              var chartElement = document.getElementById('revenue-chart');
              if (chartElement && chartElement.querySelector('canvas')) {
                var canvas = chartElement.querySelector('canvas');
                console.log('✅ Chart canvas created successfully');
                console.log('Canvas size:', canvas.width, 'x', canvas.height);
                
                // Force visibility
                chartElement.style.display = 'block';
                chartElement.style.visibility = 'visible';
                chartElement.style.opacity = '1';
                canvas.style.display = 'block';
                canvas.style.visibility = 'visible';
              } else {
                console.warn('⚠️ Chart canvas not found after rendering');
              }
            } else {
              console.log('Waiting for Chartkick... Chart:', typeof Chart, 'Chartkick:', typeof Chartkick);
              setTimeout(renderChart, 100);
            }
          }
          
          // Try multiple times to ensure Chartkick is loaded
          var attempts = 0;
          var maxAttempts = 30;
          function tryRender() {
            attempts++;
            var container = document.getElementById('revenue-chart');
            if (container && typeof Chartkick !== 'undefined' && typeof Chart !== 'undefined') {
              renderChart();
            } else if (attempts < maxAttempts) {
              setTimeout(tryRender, 100);
            } else {
              console.error('❌ Failed to render chart after', maxAttempts, 'attempts');
            }
          }
          
          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', tryRender);
          } else {
            tryRender();
          }
          
          // Also try on Turbo load
          document.addEventListener('turbo:load', function() {
            setTimeout(tryRender, 200);
          });
        })();
      </script>
    <% else %>
      <div class="flex flex-col items-center justify-center h-[350px] text-center">
        <div class="w-20 h-20 bg-secondary rounded-2xl flex items-center justify-center mb-4 border border-border">
          <svg class="w-10 h-10 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
          </svg>
        </div>
        <p class="text-base font-semibold text-foreground mb-1">No revenue data yet</p>
        <p class="text-sm text-muted-foreground max-w-xs">Connect your Shopify store to see revenue trends and analytics</p>
      </div>
    <% end %>
  </div>
</div>
